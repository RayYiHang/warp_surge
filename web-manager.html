<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warp Account Manager - Webç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .main { padding: 30px; }
        .tabs {
            display: flex;
            background: #f5f5f7;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 14px;
        }
        .tab:hover { background: rgba(0, 122, 255, 0.1); }
        .tab.active {
            background: #007aff;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e1e1;
        }
        .card h3 {
            color: #1d1d1f;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group { margin-bottom: 20px; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
        }
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #fafafa;
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007aff;
            background: white;
        }
        textarea {
            height: 120px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }
        .btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
            text-decoration: none;
            user-select: none;
        }
        .btn:hover {
            background: #0051d5;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 122, 255, 0.3);
        }
        .btn:active { transform: translateY(0); }
        .btn.secondary { background: #5856d6; }
        .btn.secondary:hover { background: #434190; }
        .btn.danger { background: #ff3b30; }
        .btn.danger:hover { background: #d70015; }
        .btn.success { background: #34c759; }
        .btn.success:hover { background: #28a745; }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .account-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .account-card {
            background: white;
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
        }
        .account-card:hover {
            border-color: #007aff;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 122, 255, 0.1);
        }
        .account-card.active {
            border-color: #34c759;
            background: #f0fff4;
        }
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .account-email {
            font-weight: 600;
            color: #1d1d1f;
            word-break: break-all;
            margin-right: 10px;
        }
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status.healthy { background: #d4edda; color: #155724; }
        .status.banned { background: #f8d7da; color: #721c24; }
        .status.unhealthy { background: #fff3cd; color: #856404; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: white;
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-card:hover {
            border-color: #007aff;
            transform: translateY(-2px);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #007aff;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }
        .alert.success {
            background: #e8f5e8;
            border-color: #c3e6c3;
            color: #2e7d32;
            border-left-color: #4caf50;
        }
        .alert.error {
            background: #ffebee;
            border-color: #ffcdd2;
            color: #c62828;
            border-left-color: #f44336;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
            color: #999;
        }
        .empty-state p {
            font-size: 1.1em;
            line-height: 1.6;
        }
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #c33;
            font-size: 12px;
        }
        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #3c3;
            font-size: 12px;
        }
        .account-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .account-actions .btn {
            font-size: 12px;
            padding: 8px 16px;
            margin: 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 8px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2em; }
            .main { padding: 20px; }
            .tabs { flex-direction: column; }
            .tab { margin-bottom: 2px; }
            .account-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ Warp Account Manager</h1>
            <p>æœ¬åœ°ç®¡ç†åå° - é«˜æ•ˆç®¡ç†æ‚¨çš„Warpè´¦æˆ·</p>
        </div>

        <div class="main">
            <div class="alert">
                <strong>ğŸ“ å½“å‰è®¿é—®åœ°å€:</strong> <span id="currentUrl"></span><br>
                <strong>ğŸ”§ APIæ¥å£:</strong> <span id="apiUrl"></span>
            </div>

            <div id="messageContainer"></div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('accounts')">ğŸ‘¥ è´¦æˆ·ç®¡ç†</div>
                <div class="tab" onclick="switchTab('stats')">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</div>
                <div class="tab" onclick="switchTab('backup')">ğŸ’¾ å¤‡ä»½ç®¡ç†</div>
                <div class="tab" onclick="switchTab('tools')">ğŸ”§ ç³»ç»Ÿå·¥å…·</div>
            </div>

            <!-- è´¦æˆ·ç®¡ç† -->
            <div id="accounts" class="tab-content active">
                <div class="card">
                    <h3>â• æ·»åŠ æ–°è´¦æˆ·</h3>
                    <div class="form-group">
                        <label for="accountData">è´¦æˆ·æ•°æ® (JSONæ ¼å¼)</label>
                        <textarea id="accountData" placeholder='{
  "email": "your-email@example.com",
  "stsTokenManager": {
    "accessToken": "your_access_token",
    "refreshToken": "your_refresh_token",
    "expirationTime": 1234567890000
  }
}'></textarea>
                    </div>
                    <button class="btn" onclick="addAccount()">
                        <span id="addAccountLoading"></span>æ·»åŠ è´¦æˆ·
                    </button>
                    <button class="btn secondary" onclick="loadAccountExample()">åŠ è½½ç¤ºä¾‹</button>
                    <button class="btn secondary" onclick="validateAccountData()">éªŒè¯æ ¼å¼</button>
                </div>

                <div class="card">
                    <h3>ğŸ‘¥ è´¦æˆ·åˆ—è¡¨</h3>
                    <button class="btn" onclick="loadAccounts()">
                        <span id="accountLoading"></span>åˆ·æ–°åˆ—è¡¨
                    </button>
                    <button class="btn secondary" onclick="exportAccounts()">å¯¼å‡ºè´¦æˆ·</button>
                    <div id="accountList" class="account-grid">
                        <div class="empty-state">
                            <h3>æš‚æ— è´¦æˆ·</h3>
                            <p>ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŸ¥çœ‹å·²æ·»åŠ çš„è´¦æˆ·ï¼Œæˆ–ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ æ–°è´¦æˆ·"å¼€å§‹ä½¿ç”¨</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div id="stats" class="tab-content">
                <div class="card">
                    <h3>ğŸ“Š å­˜å‚¨ç»Ÿè®¡</h3>
                    <button class="btn" onclick="loadStats()">
                        <span id="statsLoading"></span>åŠ è½½ç»Ÿè®¡
                    </button>
                    <div id="statsGrid" class="stats-grid"></div>
                </div>

                <div class="card">
                    <h3>ğŸ”„ Tokenåˆ·æ–°ç»Ÿè®¡</h3>
                    <button class="btn" onclick="loadRefreshStats()">
                        <span id="refreshStatsLoading"></span>æŸ¥çœ‹åˆ·æ–°ç»Ÿè®¡
                    </button>
                    <div id="refreshStatsResult" class="result">ç‚¹å‡»"æŸ¥çœ‹åˆ·æ–°ç»Ÿè®¡"æŸ¥çœ‹Tokenåˆ·æ–°ç»Ÿè®¡ä¿¡æ¯</div>
                </div>

                <div class="card">
                    <h3>ğŸ“‹ ç³»ç»Ÿé€šçŸ¥</h3>
                    <button class="btn" onclick="loadNotifications()">
                        <span id="notificationsLoading"></span>æŸ¥çœ‹é€šçŸ¥
                    </button>
                    <div id="notificationsResult" class="result">ç‚¹å‡»"æŸ¥çœ‹é€šçŸ¥"æŸ¥çœ‹ç³»ç»Ÿæ¶ˆæ¯</div>
                </div>
            </div>

            <!-- å¤‡ä»½ç®¡ç† -->
            <div id="backup" class="tab-content">
                <div class="card">
                    <h3>ğŸ’¾ æ•°æ®å¤‡ä»½</h3>
                    <button class="btn success" onclick="backupData()">
                        <span id="backupLoading"></span>åˆ›å»ºå¤‡ä»½
                    </button>
                    <button class="btn secondary" onclick="scheduleBackup()">å®šæ—¶å¤‡ä»½</button>
                    <div id="backupResult" class="result">ç‚¹å‡»"åˆ›å»ºå¤‡ä»½"ç”Ÿæˆå®Œæ•´çš„è´¦æˆ·æ•°æ®å¤‡ä»½</div>
                </div>

                <div class="card">
                    <h3>ğŸ“¥ æ•°æ®æ¢å¤</h3>
                    <div class="form-group">
                        <label for="restoreData">å¤‡ä»½æ•°æ®</label>
                        <textarea id="restoreData" placeholder="ç²˜è´´ä¹‹å‰å¤‡ä»½çš„JSONæ•°æ®ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä»æ–‡ä»¶åŠ è½½"></textarea>
                    </div>
                    <input type="file" id="restoreFile" accept=".json" style="margin-bottom: 10px; display: none;">
                    <button class="btn secondary" onclick="document.getElementById('restoreFile').click()">ä»æ–‡ä»¶åŠ è½½</button>
                    <button class="btn success" onclick="restoreData()">æ¢å¤æ•°æ®</button>
                    <div id="restoreResult" class="result"></div>
                </div>
            </div>

            <!-- ç³»ç»Ÿå·¥å…· -->
            <div id="tools" class="tab-content">
                <div class="card">
                    <h3>ğŸ”§ ç³»ç»Ÿæµ‹è¯•</h3>
                    <button class="btn" onclick="testSystem()">
                        <span id="testLoading"></span>è¿è¡Œç³»ç»Ÿæµ‹è¯•
                    </button>
                    <button class="btn secondary" onclick="diagnoseSystem()">ç³»ç»Ÿè¯Šæ–­</button>
                    <div id="testResult" class="result">ç‚¹å‡»"è¿è¡Œç³»ç»Ÿæµ‹è¯•"æ£€æŸ¥æ¨¡å—å·¥ä½œçŠ¶æ€</div>
                </div>

                <div class="card">
                    <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
                    <button class="btn" onclick="loadSettings()">
                        <span id="settingsLoading"></span>åŠ è½½å½“å‰è®¾ç½®
                    </button>
                    <button class="btn secondary" onclick="showSettingsDialog()">ç¼–è¾‘è®¾ç½®</button>
                    <div id="settingsResult" class="result"></div>
                </div>

                <div class="card">
                    <h3>ğŸ—‘ï¸ æ•°æ®ç®¡ç†</h3>
                    <button class="btn danger" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                    <button class="btn secondary" onclick="resetSettings()">é‡ç½®è®¾ç½®</button>
                    <div id="clearResult" class="result"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¯¹è¯æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSettingsDialog()">&times;</span>
            <h3>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoRefresh"> è‡ªåŠ¨åˆ·æ–°Token
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="banDetection"> å¯ç”¨å°ç¦æ£€æµ‹
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="healthCheck"> å¥åº·çŠ¶æ€æ£€æŸ¥
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoSwitch"> è‡ªåŠ¨åˆ‡æ¢è´¦æˆ·
                </label>
            </div>
            <button class="btn success" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            <button class="btn secondary" onclick="closeSettingsDialog()">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        const CONFIG = {
            API_BASE: '/api',
            CURRENT_TAB: 'accounts'
        };

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ˜¾ç¤ºå½“å‰URL
            document.getElementById('currentUrl').textContent = window.location.origin;
            document.getElementById('apiUrl').textContent = window.location.origin + CONFIG.API_BASE;

            // è‡ªåŠ¨åŠ è½½è´¦æˆ·åˆ—è¡¨
            loadAccounts();

            // è®¾ç½®æ–‡ä»¶è¯»å–ç›‘å¬å™¨
            document.getElementById('restoreFile').addEventListener('change', handleFileSelect);

            // æ£€æŸ¥APIè¿æ¥
            checkAPIConnection();
        });

        // æ£€æŸ¥APIè¿æ¥
        async function checkAPIConnection() {
            try {
                const result = await apiRequest('GET', '/test');
                if (!result.success) {
                    showMessage('APIè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¡®ä¿Surgeæ¨¡å—å·²æ­£ç¡®å®‰è£…', 'error');
                }
            } catch (error) {
                showMessage('æ— æ³•è¿æ¥åˆ°APIæœåŠ¡ï¼Œè¯·æ£€æŸ¥Surgeé…ç½®', 'error');
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            CONFIG.CURRENT_TAB = tabName;
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(method, endpoint, data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(CONFIG.API_BASE + endpoint, options);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return { success: false, error: error.message };
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info', duration = 5000) {
            const container = document.getElementById('messageContainer');
            const alertClass = type === 'error' ? 'alert error' : type === 'success' ? 'alert success' : 'alert';

            const alertDiv = document.createElement('div');
            alertDiv.className = alertClass;
            alertDiv.textContent = message;

            container.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, duration);
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function setLoading(elementId, show = true) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = show ? '<span class="loading"></span> ' : '';
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, data) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (typeof data === 'object') {
                element.textContent = JSON.stringify(data, null, 2);
            } else {
                element.textContent = data;
            }
        }

        // éªŒè¯è´¦æˆ·æ•°æ®æ ¼å¼
        function validateAccountData() {
            const accountData = document.getElementById('accountData').value;
            if (!accountData.trim()) {
                showMessage('è¯·è¾“å…¥è´¦æˆ·æ•°æ®', 'error');
                return;
            }

            try {
                const data = JSON.parse(accountData);

                if (!data.email) {
                    throw new Error('ç¼ºå°‘emailå­—æ®µ');
                }

                if (!data.stsTokenManager) {
                    throw new Error('ç¼ºå°‘stsTokenManagerå­—æ®µ');
                }

                if (!data.stsTokenManager.accessToken) {
                    throw new Error('ç¼ºå°‘accessTokenå­—æ®µ');
                }

                if (!data.stsTokenManager.refreshToken) {
                    throw new Error('ç¼ºå°‘refreshTokenå­—æ®µ');
                }

                if (!data.stsTokenManager.expirationTime) {
                    throw new Error('ç¼ºå°‘expirationTimeå­—æ®µ');
                }

                showMessage('è´¦æˆ·æ•°æ®æ ¼å¼éªŒè¯é€šè¿‡ï¼', 'success');
                return true;
            } catch (error) {
                showMessage('JSONæ ¼å¼é”™è¯¯: ' + error.message, 'error');
                return false;
            }
        }

        // æ·»åŠ è´¦æˆ·
        async function addAccount() {
            if (!validateAccountData()) {
                return;
            }

            setLoading('addAccountLoading', true);

            try {
                const accountData = JSON.parse(document.getElementById('accountData').value);
                const result = await apiRequest('POST', '/accounts', accountData);

                if (result.success) {
                    document.getElementById('accountData').value = '';
                    showMessage('è´¦æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    loadAccounts();
                } else {
                    showMessage('æ·»åŠ å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                setLoading('addAccountLoading', false);
            }
        }

        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            setLoading('accountLoading', true);

            try {
                const result = await apiRequest('GET', '/accounts');

                if (result.success) {
                    const accounts = result.data || [];
                    displayAccounts(accounts);
                } else {
                    document.getElementById('accountList').innerHTML =
                        '<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3><p>' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</p></div>';
                    showMessage('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                document.getElementById('accountList').innerHTML =
                    '<div class="empty-state"><h3>ç½‘ç»œé”™è¯¯</h3><p>' + error.message + '</p></div>';
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            } finally {
                setLoading('accountLoading', false);
            }
        }

        // æ˜¾ç¤ºè´¦æˆ·åˆ—è¡¨
        function displayAccounts(accounts) {
            const container = document.getElementById('accountList');

            if (accounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>æš‚æ— è´¦æˆ·</h3><p>ç‚¹å‡»"æ·»åŠ æ–°è´¦æˆ·"å¼€å§‹ä½¿ç”¨</p></div>';
                return;
            }

            const html = accounts.map(account => `
                <div class="account-card ${account.isActive ? 'active' : ''}">
                    <div class="account-header">
                        <div class="account-email" title="${account.email}">${account.email}</div>
                        <span class="status ${account.healthStatus}">${account.healthStatus}</span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <small>æœ€åæ›´æ–°: ${new Date(account.lastUpdated).toLocaleString()}</small>
                    </div>
                    <div class="account-actions">
                        ${!account.isActive ?
                            `<button class="btn" onclick="switchAccount('${account.email}')">è®¾ä¸ºæ´»è·ƒ</button>` :
                            '<span style="color: #34c759; font-weight: 600;">âœ… å½“å‰æ´»è·ƒ</span>'
                        }
                        <button class="btn danger" onclick="deleteAccount('${account.email}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // åˆ‡æ¢è´¦æˆ·
        async function switchAccount(email) {
            if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°è´¦æˆ· ${email} å—ï¼Ÿ`)) return;

            try {
                const result = await apiRequest('POST', '/switch', { email });

                if (result.success) {
                    showMessage('è´¦æˆ·åˆ‡æ¢æˆåŠŸï¼', 'success');
                    loadAccounts();
                } else {
                    showMessage('åˆ‡æ¢å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åˆ é™¤è´¦æˆ·
        async function deleteAccount(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦æˆ· ${email} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

            try {
                const result = await apiRequest('DELETE', `/accounts/${encodeURIComponent(email)}`);

                if (result.success) {
                    showMessage('è´¦æˆ·åˆ é™¤æˆåŠŸï¼', 'success');
                    loadAccounts();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            setLoading('statsLoading', true);

            try {
                const result = await apiRequest('GET', '/stats');

                if (result.success) {
                    const stats = result.data || {};
                    displayStats(stats);
                } else {
                    showResult('statsGrid', 'åŠ è½½å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    showMessage('ç»Ÿè®¡ä¿¡æ¯åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('statsGrid', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            } finally {
                setLoading('statsLoading', false);
            }
        }

        // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        function displayStats(stats) {
            const container = document.getElementById('statsGrid');
            const html = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalAccounts || 0}</div>
                    <div class="stat-label">æ€»è´¦æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.healthyAccounts || 0}</div>
                    <div class="stat-label">å¥åº·è´¦æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.bannedAccounts || 0}</div>
                    <div class="stat-label">è¢«å°è´¦æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.hasBackup ? 'æœ‰' : 'æ— '}</div>
                    <div class="stat-label">å¤‡ä»½çŠ¶æ€</div>
                </div>
            `;
            container.innerHTML = html;
        }

        // åŠ è½½Tokenåˆ·æ–°ç»Ÿè®¡
        async function loadRefreshStats() {
            setLoading('refreshStatsLoading', true);

            try {
                const result = await apiRequest('GET', '/refresh-stats');
                showResult('refreshStatsResult', result);
            } catch (error) {
                showResult('refreshStatsResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('åŠ è½½åˆ·æ–°ç»Ÿè®¡å¤±è´¥', 'error');
            } finally {
                setLoading('refreshStatsLoading', false);
            }
        }

        // åŠ è½½é€šçŸ¥
        async function loadNotifications() {
            setLoading('notificationsLoading', true);

            try {
                const result = await apiRequest('GET', '/notifications');
                showResult('notificationsResult', result);
            } catch (error) {
                showResult('notificationsResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('åŠ è½½é€šçŸ¥å¤±è´¥', 'error');
            } finally {
                setLoading('notificationsLoading', false);
            }
        }

        // å¤‡ä»½æ•°æ®
        async function backupData() {
            setLoading('backupLoading', true);

            try {
                const result = await apiRequest('GET', '/backup');

                if (result.success) {
                    const backupData = result.data;
                    showResult('backupResult', backupData);

                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    try {
                        await navigator.clipboard.writeText(JSON.stringify(backupData, null, 2));
                        showMessage('å¤‡ä»½å·²ç”Ÿæˆå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');

                        // æä¾›ä¸‹è½½
                        downloadBackup(backupData);
                    } catch (clipboardError) {
                        showMessage('å¤‡ä»½å·²ç”Ÿæˆï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'success');
                        downloadBackup(backupData);
                    }
                } else {
                    showResult('backupResult', 'å¤‡ä»½å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    showMessage('æ•°æ®å¤‡ä»½å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('backupResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            } finally {
                setLoading('backupLoading', false);
            }
        }

        // ä¸‹è½½å¤‡ä»½æ–‡ä»¶
        function downloadBackup(data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `warp-backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æ¢å¤æ•°æ®
        async function restoreData() {
            const backupString = document.getElementById('restoreData').value;
            if (!backupString.trim()) {
                showMessage('è¯·è¾“å…¥å¤‡ä»½æ•°æ®', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦æ¢å¤æ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) return;

            try {
                const result = await apiRequest('POST', '/restore', { backupData: backupString });

                if (result.success) {
                    showMessage('æ•°æ®æ¢å¤æˆåŠŸï¼', 'success');
                    document.getElementById('restoreData').value = '';
                    loadAccounts();
                    loadStats();
                } else {
                    showResult('restoreResult', 'æ¢å¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    showMessage('æ•°æ®æ¢å¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('restoreResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            }
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('restoreData').value = e.target.result;
                };
                reader.readAsText(file);
            }
        }

        // ç³»ç»Ÿæµ‹è¯•
        async function testSystem() {
            setLoading('testLoading', true);

            try {
                const result = await apiRequest('POST', '/test');
                showResult('testResult', result);

                if (result.success) {
                    showMessage('ç³»ç»Ÿæµ‹è¯•é€šè¿‡ï¼', 'success');
                } else {
                    showMessage('ç³»ç»Ÿæµ‹è¯•å‘ç°é—®é¢˜', 'error');
                }
            } catch (error) {
                showResult('testResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            } finally {
                setLoading('testLoading', false);
            }
        }

        // ç³»ç»Ÿè¯Šæ–­
        async function diagnoseSystem() {
            try {
                const testResult = await apiRequest('POST', '/test');
                const statsResult = await apiRequest('GET', '/stats');
                const settingsResult = await apiRequest('GET', '/settings');

                const diagnosis = {
                    timestamp: new Date().toISOString(),
                    apiConnection: testResult.success,
                    dataAccess: statsResult.success,
                    settingsAccess: settingsResult.success,
                    recommendations: []
                };

                if (!diagnosis.apiConnection) {
                    diagnosis.recommendations.push('æ£€æŸ¥Surgeæ¨¡å—æ˜¯å¦æ­£ç¡®å®‰è£…');
                }
                if (!diagnosis.dataAccess) {
                    diagnosis.recommendations.push('æ£€æŸ¥æ•°æ®å­˜å‚¨æƒé™');
                }
                if (!diagnosis.settingsAccess) {
                    diagnosis.recommendations.push('é‡ç½®ç³»ç»Ÿè®¾ç½®');
                }

                showResult('testResult', diagnosis);
                showMessage('ç³»ç»Ÿè¯Šæ–­å®Œæˆ', 'info');
            } catch (error) {
                showResult('testResult', 'è¯Šæ–­å¤±è´¥: ' + error.message);
                showMessage('ç³»ç»Ÿè¯Šæ–­å¤±è´¥', 'error');
            }
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            setLoading('settingsLoading', true);

            try {
                const result = await apiRequest('GET', '/settings');
                showResult('settingsResult', result);

                if (result.success) {
                    // æ›´æ–°è®¾ç½®å¯¹è¯æ¡†
                    const settings = result.data;
                    document.getElementById('autoRefresh').checked = settings.autoRefresh;
                    document.getElementById('banDetection').checked = settings.banDetection;
                    document.getElementById('healthCheck').checked = settings.healthCheck;
                    document.getElementById('autoSwitch').checked = settings.autoSwitch;
                }
            } catch (error) {
                showResult('settingsResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('åŠ è½½è®¾ç½®å¤±è´¥', 'error');
            } finally {
                setLoading('settingsLoading', false);
            }
        }

        // æ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
        function showSettingsDialog() {
            document.getElementById('settingsModal').style.display = 'block';
            loadSettings();
        }

        // å…³é—­è®¾ç½®å¯¹è¯æ¡†
        function closeSettingsDialog() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // ä¿å­˜è®¾ç½®
        async function saveSettings() {
            const settings = {
                autoRefresh: document.getElementById('autoRefresh').checked,
                banDetection: document.getElementById('banDetection').checked,
                healthCheck: document.getElementById('healthCheck').checked,
                autoSwitch: document.getElementById('autoSwitch').checked
            };

            try {
                const result = await apiRequest('POST', '/settings', { settings });

                if (result.success) {
                    showMessage('è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    closeSettingsDialog();
                } else {
                    showMessage('è®¾ç½®ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nå»ºè®®å…ˆå¤‡ä»½æ•°æ®ã€‚')) {
                return;
            }

            if (!confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è´¦æˆ·æ•°æ®ã€è®¾ç½®å’Œå¤‡ä»½å—ï¼Ÿ')) {
                return;
            }

            try {
                const result = await apiRequest('DELETE', '/clear');

                if (result.success) {
                    showMessage('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼', 'success');
                    loadAccounts();
                    loadStats();
                    showResult('clearResult', result);
                } else {
                    showResult('clearResult', 'æ¸…é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    showMessage('æ•°æ®æ¸…é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showResult('clearResult', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                showMessage('ç½‘ç»œè¿æ¥å¤±è´¥', 'error');
            }
        }

        // é‡ç½®è®¾ç½®
        async function resetSettings() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) return;

            try {
                const defaultSettings = {
                    autoRefresh: true,
                    banDetection: true,
                    healthCheck: true,
                    autoSwitch: false
                };

                const result = await apiRequest('POST', '/settings', { settings: defaultSettings });

                if (result.success) {
                    showMessage('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼', 'success');
                    loadSettings();
                } else {
                    showMessage('è®¾ç½®é‡ç½®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // å¯¼å‡ºè´¦æˆ·
        async function exportAccounts() {
            try {
                const result = await apiRequest('GET', '/accounts');

                if (result.success) {
                    downloadBackup(result.data);
                    showMessage('è´¦æˆ·æ•°æ®å·²å¯¼å‡ºï¼', 'success');
                } else {
                    showMessage('å¯¼å‡ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // å®šæ—¶å¤‡ä»½
        function scheduleBackup() {
            showMessage('å®šæ—¶å¤‡ä»½åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åŠ è½½è´¦æˆ·ç¤ºä¾‹
        function loadAccountExample() {
            const example = {
                email: "example@warp.dev",
                stsTokenManager: {
                    accessToken: "example_access_token_here",
                    refreshToken: "example_refresh_token_here",
                    expirationTime: Date.now() + 3600000
                }
            };
            document.getElementById('accountData').value = JSON.stringify(example, null, 2);
            showMessage('å·²åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œè¯·æ›¿æ¢ä¸ºçœŸå®æ•°æ®', 'info');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>