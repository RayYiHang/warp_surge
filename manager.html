<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warp Account Manager - ç®¡ç†ç•Œé¢</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1d1d1f;
            text-align: center;
            margin-bottom: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
        }

        .section h3 {
            color: #1d1d1f;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #1d1d1f;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d1d1;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #0051d5;
        }

        button.secondary {
            background: #5856d6;
        }

        button.danger {
            background: #ff3b30;
        }

        .result {
            background: #f0f0f0;
            border: 1px solid #d1d1d1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .account-list {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
        }

        .account-item {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .account-item h4 {
            margin: 0 0 10px 0;
            color: #1d1d1f;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status.healthy {
            background: #d4edda;
            color: #155724;
        }

        .status.banned {
            background: #f8d7da;
            color: #721c24;
        }

        .status.unhealthy {
            background: #fff3cd;
            color: #856404;
        }

        .alert {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1565c0;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #e1e1e1;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: #007aff;
            color: #007aff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Warp Account Manager</h1>

        <div class="alert">
            <strong>ğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š</strong> æ­¤ç•Œé¢éœ€è¦é€šè¿‡Surgeä»£ç†è®¿é—®ï¼Œè¯·ç¡®ä¿Surgeä¸­çš„Warpæ¨¡å—å·²æ­£ç¡®å®‰è£…å¹¶å¯ç”¨ã€‚
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('accounts')">è´¦æˆ·ç®¡ç†</div>
            <div class="tab" onclick="switchTab('stats')">çŠ¶æ€ç»Ÿè®¡</div>
            <div class="tab" onclick="switchTab('backup')">æ•°æ®å¤‡ä»½</div>
            <div class="tab" onclick="switchTab('tools')">å·¥å…·ç®±</div>
        </div>

        <!-- è´¦æˆ·ç®¡ç† -->
        <div id="accounts" class="tab-content active">
            <div class="section">
                <h3>â• æ·»åŠ æ–°è´¦æˆ·</h3>
                <div class="form-group">
                    <label for="accountData">è´¦æˆ·æ•°æ® (JSONæ ¼å¼)</label>
                    <textarea id="accountData" placeholder='{
  "email": "your-email@example.com",
  "stsTokenManager": {
    "accessToken": "...",
    "refreshToken": "...",
    "expirationTime": 1234567890000
  }
}'></textarea>
                </div>
                <button onclick="addAccount()">æ·»åŠ è´¦æˆ·</button>
            </div>

            <div class="section">
                <h3>ğŸ‘¥ è´¦æˆ·åˆ—è¡¨</h3>
                <button onclick="loadAccounts()">åˆ·æ–°åˆ—è¡¨</button>
                <div id="accountList" class="account-list">
                    <p>ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŸ¥çœ‹è´¦æˆ·</p>
                </div>
            </div>

            <div class="section">
                <h3>ğŸ”„ åˆ‡æ¢æ´»è·ƒè´¦æˆ·</h3>
                <div class="form-group">
                    <label for="switchEmail">é€‰æ‹©è´¦æˆ·</label>
                    <select id="switchEmail">
                        <option value="">è¯·å…ˆåˆ·æ–°è´¦æˆ·åˆ—è¡¨</option>
                    </select>
                </div>
                <button onclick="switchAccount()">åˆ‡æ¢è´¦æˆ·</button>
            </div>
        </div>

        <!-- çŠ¶æ€ç»Ÿè®¡ -->
        <div id="stats" class="tab-content">
            <div class="section">
                <h3>ğŸ“Š å­˜å‚¨ç»Ÿè®¡</h3>
                <button onclick="loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
                <div id="statsResult" class="result">ç‚¹å‡»"åˆ·æ–°ç»Ÿè®¡"æŸ¥çœ‹æ•°æ®</div>
            </div>

            <div class="section">
                <h3>ğŸ”„ Tokenåˆ·æ–°ç»Ÿè®¡</h3>
                <button onclick="loadRefreshStats()">æŸ¥çœ‹åˆ·æ–°ç»Ÿè®¡</button>
                <div id="refreshStatsResult" class="result">ç‚¹å‡»"æŸ¥çœ‹åˆ·æ–°ç»Ÿè®¡"æŸ¥çœ‹æ•°æ®</div>
            </div>

            <div class="section">
                <h3>ğŸ“‹ æœ€è¿‘é€šçŸ¥</h3>
                <button onclick="loadNotifications()">æŸ¥çœ‹é€šçŸ¥</button>
                <div id="notificationsResult" class="result">ç‚¹å‡»"æŸ¥çœ‹é€šçŸ¥"æŸ¥çœ‹æ•°æ®</div>
            </div>
        </div>

        <!-- æ•°æ®å¤‡ä»½ -->
        <div id="backup" class="tab-content">
            <div class="section">
                <h3>ğŸ’¾ å¤‡ä»½æ•°æ®</h3>
                <button onclick="backupData()">åˆ›å»ºå¤‡ä»½</button>
                <div id="backupResult" class="result">ç‚¹å‡»"åˆ›å»ºå¤‡ä»½"ç”Ÿæˆæ•°æ®</div>
            </div>

            <div class="section">
                <h3>ğŸ“¥ æ¢å¤æ•°æ®</h3>
                <div class="form-group">
                    <label for="restoreData">å¤‡ä»½æ•°æ®</label>
                    <textarea id="restoreData" placeholder="ç²˜è´´å¤‡ä»½æ•°æ®JSON"></textarea>
                </div>
                <button onclick="restoreData()" class="danger">æ¢å¤æ•°æ®</button>
                <div id="restoreResult" class="result"></div>
            </div>

            <div class="section">
                <h3>ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</h3>
                <button onclick="clearAllData()" class="danger">æ¸…é™¤æ•°æ®</button>
                <div id="clearResult" class="result"></div>
            </div>
        </div>

        <!-- å·¥å…·ç®± -->
        <div id="tools" class="tab-content">
            <div class="section">
                <h3>ğŸ”§ æµ‹è¯•æ¨¡å—</h3>
                <button onclick="testModule()">è¿è¡Œæµ‹è¯•</button>
                <div id="testResult" class="result">ç‚¹å‡»"è¿è¡Œæµ‹è¯•"æŸ¥çœ‹ç»“æœ</div>
            </div>

            <div class="section">
                <h3>âš™ï¸ è®¾ç½®é…ç½®</h3>
                <div class="form-group">
                    <label for="settingsData">è®¾ç½®æ•°æ® (JSONæ ¼å¼)</label>
                    <textarea id="settingsData" placeholder='{
  "autoRefresh": true,
  "banDetection": true,
  "healthCheck": true
}'></textarea>
                </div>
                <button onclick="updateSettings()">æ›´æ–°è®¾ç½®</button>
                <button onclick="loadSettings()">åŠ è½½å½“å‰è®¾ç½®</button>
                <div id="settingsResult" class="result"></div>
            </div>

            <div class="section">
                <h3>ğŸ” æŸ¥çœ‹æ´»è·ƒè´¦æˆ·</h3>
                <button onclick="viewActiveAccount()">æŸ¥çœ‹å½“å‰æ´»è·ƒè´¦æˆ·</button>
                <div id="activeAccountResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // Surge APIåŸºç¡€é…ç½®
        const SURGE_API_BASE = 'http://127.0.0.1:6155/v1/scripts';

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // æ‰§è¡ŒSurgeè„šæœ¬
        async function executeScript(scriptName, code) {
            try {
                const response = await fetch(`${SURGE_API_BASE}/${scriptName}/evaluate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();
                return result;
            } catch (error) {
                return { error: error.message };
            }
        }

        // æ·»åŠ è´¦æˆ·
        async function addAccount() {
            const accountData = document.getElementById('accountData').value;
            if (!accountData.trim()) {
                alert('è¯·è¾“å…¥è´¦æˆ·æ•°æ®');
                return;
            }

            const code = `accountManager.addAccount(${accountData})`;
            const result = await executeScript('warp-account-manager', code);

            document.getElementById('accountData').value = '';
            showResult('addAccountResult', result);
            loadAccounts(); // åˆ·æ–°è´¦æˆ·åˆ—è¡¨
        }

        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            const code = 'accountManager.getAccountList()';
            const result = await executeScript('warp-account-manager', code);

            if (result.error) {
                document.getElementById('accountList').innerHTML = `<p style="color: red;">é”™è¯¯: ${result.error}</p>`;
                return;
            }

            const accounts = result.result || [];
            const accountListHtml = accounts.map(account => `
                <div class="account-item">
                    <h4>${account.email} ${account.isActive ? 'âœ…' : ''}</h4>
                    <p>çŠ¶æ€: <span class="status ${account.healthStatus}">${account.healthStatus}</span></p>
                    <p>æœ€åæ›´æ–°: ${new Date(account.lastUpdated).toLocaleString()}</p>
                    <button onclick="deleteAccount('${account.email}')" class="danger">åˆ é™¤</button>
                </div>
            `).join('');

            document.getElementById('accountList').innerHTML = accountListHtml || '<p>æš‚æ— è´¦æˆ·</p>';

            // æ›´æ–°åˆ‡æ¢è´¦æˆ·çš„ä¸‹æ‹‰é€‰é¡¹
            const switchSelect = document.getElementById('switchEmail');
            switchSelect.innerHTML = accounts.map(account =>
                `<option value="${account.email}">${account.email} ${account.isActive ? '(å½“å‰)' : ''}</option>`
            ).join('');
        }

        // åˆ‡æ¢è´¦æˆ·
        async function switchAccount() {
            const email = document.getElementById('switchEmail').value;
            if (!email) {
                alert('è¯·é€‰æ‹©è´¦æˆ·');
                return;
            }

            const code = `accountManager.setActiveAccount('${email}')`;
            const result = await executeScript('warp-account-manager', code);

            showResult('switchResult', result);
            loadAccounts(); // åˆ·æ–°è´¦æˆ·åˆ—è¡¨
        }

        // åˆ é™¤è´¦æˆ·
        async function deleteAccount(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦æˆ· ${email} å—ï¼Ÿ`)) {
                return;
            }

            const code = `accountManager.deleteAccount('${email}')`;
            const result = await executeScript('warp-account-manager', code);

            showResult('deleteResult', result);
            loadAccounts(); // åˆ·æ–°è´¦æˆ·åˆ—è¡¨
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            const code = 'persistenceManager.getStorageStats()';
            const result = await executeScript('warp-data-persistence', code);
            showResult('statsResult', result);
        }

        // åŠ è½½Tokenåˆ·æ–°ç»Ÿè®¡
        async function loadRefreshStats() {
            const code = 'tokenRefreshService.getRefreshStats()';
            const result = await executeScript('warp-token-refresh', code);
            showResult('refreshStatsResult', result);
        }

        // åŠ è½½é€šçŸ¥
        async function loadNotifications() {
            const code = 'responseHandler.getRecentNotifications(20)';
            const result = await executeScript('warp-response-handler', code);
            showResult('notificationsResult', result);
        }

        // å¤‡ä»½æ•°æ®
        async function backupData() {
            const code = 'persistenceManager.backupData()';
            const result = await executeScript('warp-data-persistence', code);
            showResult('backupResult', result);
        }

        // æ¢å¤æ•°æ®
        async function restoreData() {
            const backupString = document.getElementById('restoreData').value;
            if (!backupString.trim()) {
                alert('è¯·è¾“å…¥å¤‡ä»½æ•°æ®');
                return;
            }

            const code = `persistenceManager.restoreData(\`${backupString}\`)`;
            const result = await executeScript('warp-data-persistence', code);

            showResult('restoreResult', result);
            document.getElementById('restoreData').value = '';
            loadAccounts(); // åˆ·æ–°è´¦æˆ·åˆ—è¡¨
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            const code = 'persistenceManager.clearAllData()';
            const result = await executeScript('warp-data-persistence', code);

            showResult('clearResult', result);
            loadAccounts(); // åˆ·æ–°è´¦æˆ·åˆ—è¡¨
        }

        // æµ‹è¯•æ¨¡å—
        async function testModule() {
            const testCode = `
console.log("=== Warp Account Manager æµ‹è¯• ===");

// æµ‹è¯•è´¦æˆ·æ•°æ®
const testAccount = {
    "email": "test@example.com",
    "stsTokenManager": {
        "accessToken": "test_token_123",
        "refreshToken": "refresh_token_456",
        "expirationTime": Date.now() + 3600000
    }
};

console.log("1. æ·»åŠ æµ‹è¯•è´¦æˆ·...");
const addResult = accountManager.addAccount(testAccount);
console.log(JSON.stringify(addResult, null, 2));

console.log("2. è·å–è´¦æˆ·åˆ—è¡¨...");
const accounts = accountManager.getAccountList();
console.log(JSON.stringify(accounts, null, 2));

console.log("3. è·å–å­˜å‚¨ç»Ÿè®¡...");
const stats = persistenceManager.getStorageStats();
console.log(JSON.stringify(stats, null, 2));

console.log("=== æµ‹è¯•å®Œæˆ ===");

{
    accounts: accounts,
    stats: stats,
    testResult: addResult
}
            `;

            const result = await executeScript('warp-account-manager', testCode);
            showResult('testResult', result);
        }

        // åŠ è½½è®¾ç½®
        async function loadSettings() {
            const code = 'persistenceManager.getSettings()';
            const result = await executeScript('warp-data-persistence', code);

            if (result.result && result.result.settings) {
                document.getElementById('settingsData').value = JSON.stringify(result.result.settings, null, 2);
            }
            showResult('settingsResult', result);
        }

        // æ›´æ–°è®¾ç½®
        async function updateSettings() {
            const settingsData = document.getElementById('settingsData').value;
            if (!settingsData.trim()) {
                alert('è¯·è¾“å…¥è®¾ç½®æ•°æ®');
                return;
            }

            const code = `persistenceManager.setSettings(${settingsData})`;
            const result = await executeScript('warp-data-persistence', code);

            showResult('settingsResult', result);
        }

        // æŸ¥çœ‹æ´»è·ƒè´¦æˆ·
        async function viewActiveAccount() {
            const code = 'accountManager.getActiveAccount()';
            const result = await executeScript('warp-account-manager', code);
            showResult('activeAccountResult', result);
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, result) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (result.error) {
                element.textContent = `é”™è¯¯: ${result.error}`;
                element.style.color = 'red';
            } else {
                element.textContent = JSON.stringify(result.result || result, null, 2);
                element.style.color = 'inherit';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½è´¦æˆ·åˆ—è¡¨
        window.addEventListener('load', function() {
            loadAccounts();
        });
    </script>
</body>
</html>